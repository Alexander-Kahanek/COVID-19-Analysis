---
title: "Covid-19 Analysis"
author: "Alexander Kahanek"
date: "3/24/2020"
output: 
    html_document:
        number_sections: true
        toc: true
        theme: cosmo
        highlight: tango
        code_folding: hide
---

```{r}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

# Welcome

data gathered from
https://data.humdata.org/dataset/novel-coronavirus-2019-ncov-cases

# Cleaning data

Here I am doing a few things:

* I made a row for each status, including a new active status

    + $Acive = Confirmed - (Deaths + Recovered)$

* I got rid of all columns except Country, Status, Value, Date

* I added a new region called "Global", this holds all the values for every country combined

* I ran a short algorithm to get the per day change, aswell as the rate of change per day

* I got a dataframe of the totals for each Country and Status, aswell as add the active status for this dataframe

What I need to do:

    Import data of testing

```{r}
options(stringsAsFactors=FALSE)
library(plyr)
library(dplyr)
library(reshape2)
library(ggplot2)
library(plotly)
library(highcharter)

#function for grabbing status from my filenames
getStatus<- function(x){
  strsplit(x, "-")[[1]] %>%
    last() %>%
    gsub(pattern="\\.csv", replacement="")
}

#function created for adding an active status
createActive <- function(x){
  dcast(Country.Region + Date ~ Status,
        data=x, value.var="Value") %>%
    mutate(Active = Confirmed - (Deaths + Recovered)) %>% 
    melt(id = c("Country.Region", "Date"))
}

#function used to convert a dataset from long to wide
convert <- function(x){ dcast(Country + Date ~ Status,
        data=x, value.var="Value")}

###########################################
### This is where I start cleaning the data
files <- list.files("raw", full.names = TRUE)

raw <- files %>% #read in files
  lapply(function(x){
  read.csv(x) %>% 
    mutate(
      Date = as.Date(Date, "%m/%d/%Y"),
      Status = getStatus(x) #add status
    )
}) %>% 
  bind_rows() %>% #combine files
  subset(!(Value==0) )

raw <- raw %>% #combine countries into one
  group_by(Country.Region, Date, Status) %>% 
  summarise(
    Value = sum(Value)
  )

raw <- raw %>% #get global stats
  group_by(Date, Status) %>% 
  summarise(
    Value = sum(Value)
  ) %>% 
  ungroup() %>% 
  mutate(
    Country.Region = "Global"
  ) %>% 
  bind_rows(raw)

raw <- raw %>% #create active columns, delete nulls, rename
  createActive() %>% 
  subset(!is.na(value)) %>% 
  rename(
   Country = Country.Region,
    Value = value,
    Status = variable
  )

total <- raw %>% #Get total values for seperate df
  group_by(Country, Status) %>% 
  summarise(
    Value = max(Value)
  ) %>% 
  ungroup() %>% 
  mutate(
    Status = as.character(Status)
  )

#get change per day
raw <- raw %>%
  group_by(Country, Status) %>% 
  mutate(
    Change =  Value - lag(Value, k=1),
    Rate_Change =  (Value - lag(Value, k=1))/lag(Value, k=1) 
    ) %>% 
  ungroup() %>% 
  mutate(
    Status = as.character(Status)
  )
```

Now that the data is clean, lets start digging into the data!

# A Quick Analysis


## Cumulative Total Cases
```{r}
plot_data <- total %>% 
  subset(Country %in% c("US", "China", "Italy", "Germany", "Spain"))

p <- plot_data %>% 
  ggplot(aes(reorder(Status,Value), Value, fill = Country))+
  geom_bar(stat="identity")+ coord_flip()+ xlab("Status of Case")+ ylab("Total Cases")+ ggtitle("Number of Cases for top 5 countries")
p <- ggplotly(p)

p
```

The above graph shows the variance of cumulative cases by type, and by country. We can see some pretty interesting things here. For example, Italy has the highest deaths and active cases, yet they are only second in the number of confirmed cases. This could mean a few things:

* Italy may not have been testing enough people, which would bring their Mortality Rate up.

* Italys' healthcare system is getting overrun, and their deaths are about to skyrocket.

```{r}
total %>% 
  subset(Country %in% c("US", "China", "Italy", "Germany", "Spain")) %>% 
  subset(Status == "Deaths") %>% 
  hchart("treemap",
         colorByPoint = TRUE,
         hcaes(x = Country, value = Value)) %>% 
  hc_add_theme(hc_theme_flat()) %>% 
  hc_title(text = "Total Deaths by Country",
           align = "left")
```

This graph perfectly shows just how many Deaths Italy has compared to our top 5 countries. At the time of writing this, Italy has just about doubled their death count over Chinas'!

For the remainder of this analysis, I will be focusing on Italy.

## Rates of Change

Theres a couple things to keep in mind when looking at the rate of change.

* It has more variance in the beginning.

* As the number of cases get larger, the rate will tend to even out, or even decline.

This is the basic Exponential growth function:
    
**$f(x) = P_0(1+r)^d$**
   
The rate is what gets exponentiated for an exponential function, ie, if our mean rate is higher, our confirmed cases will get exponentially higher with each day. Also, if the rate is negative that means our cases per day has dropped from the previous days' number. If there starts to be a trend of negative rates, this means that the disease is starting to slow down, which could mean we are past the peak.

```{r}
plot_data <- raw %>% 
  subset(Country == "Italy") %>% 
  subset(!(is.na(Rate_Change))) %>% 
  subset(Rate_Change <= 1)

p_c = plot_data %>% 
  subset(Status == "Confirmed")

p_d = plot_data %>% 
  subset(Status == "Deaths")

p_a = plot_data %>% 
  subset(Status == "Active")

hchart(density(p_a$Rate_Change), type = "area", color = "yellow", name = "Rate of Active") %>% 
   hc_add_series(density(p_c$Rate_Change), type = "area", name = "Rate of Confirmed", color = "green") %>% 
  hc_add_series(density(p_d$Rate_Change), type = "area", name = "Rate of Deaths", color = "red") %>% 
  hc_add_theme(hc_theme_flat()) %>% 
  hc_title(text = "Distribion of the Rate of Change, per Day",
           align = "left") %>% 
  hc_subtitle(text = "For Italy",
              align = "left") %>% 
  hc_yAxis(labels = list(format = "{value}")) %>% 
  hc_xAxis(labels = list(format = "{value}"),
           title = list(text = "Rate of Change"))%>% 
  hc_legend(align = "left")
```

This graph clearly shows that the deaths rate of change has not only a higher average, but most of the rates are higher than the rate of confirmed. This tells us the number of deaths are going up much faster than our confirmed cases are.

There are a multitude of reasons why this could happen:

* The Confirmed cases are lagging behind, due to the incubation period.

* The Confirmed cases are innacurate, as finding this true value is difficult.

* Our Mortality rate is not static
  + This is a likely scenario for a few reasons.
    - Healthcare systems can be overrun, causing more deaths.
    - Population ages vary depending on location, and we know Covid-19 has a higher Mortality rate among an older population.

* Rates tend to even out over time, meaning in the beginning stages the rate of change will be much higher than later on.
  + If we have 1 person infected today, and another tomorrow, the rate of change from day 1 to day 2 is 2.0

## Deeper look at Italys' Death Rate of Change

```{r}
raw %>% 
  subset(Country == "Italy") %>% 
  subset(!(is.na(Rate_Change))) %>% 
  subset(Status == "Deaths") %>% 
  hchart( type = "scatter",
          hcaes(y = Rate_Change, x = Change),
          color = "red",
          regression = TRUE,
          borderColor = '#EBBA95',
           borderRadius = 10,
           borderWidth = 2) %>% 
  hc_add_theme(hc_theme_flat()) %>% 
  hc_add_dependency("plugins/highcharts-regression.js") %>% 
  hc_title(text = "Rate of Change vs Actual Change",
           align = "left") %>% 
  hc_subtitle(text = "For Italys' Deaths",
              align = "left") %>% 
  hc_yAxis(labels = list(format = "{value}"),
           title = list(text = "Rate of change")) %>% 
  hc_xAxis(labels = list(format = "{value}"),
           title = list(text = "Cases per Day")) %>% 
   hc_legend(align = "left")
```

Looking at this scatter plot, as the number of Deceased cases rise, the Rate of Change trends downwards. This means that Italy has a negative correlation between the actual change in cases per day and the rate of change. This is a good thing, as it could mean a few things:

* The infection rate is starting to slow down.
* The rate of change is starting to average out to a lower number.

Lets find out how well correlated the two actually are, using pearsons' method.


Before we start, I will get the outliers out of the data, as some of the early rates are innacurate, for the reasons described before.

```{r}
corr <- raw %>% #subsetting our data
  subset(Country == "Italy") %>% 
  subset(!(is.na(Rate_Change))) %>%
  subset(!(is.na(Change))) %>%
  subset(Status == "Deaths", select = c(Value, Change, Rate_Change))

rc_sd = sd(corr$Rate_Change) #standard deviation for rate of change
rc_mean = mean(corr$Rate_Change) #mean for rate of change

cd_sd = sd(corr$Change) #standard deviation for cases per day
cd_mean = mean(corr$Change) #mean for cases per day

corr <- corr %>% #removing outliers
  subset(rc_mean-rc_sd*3 <= Rate_Change | Rate_Change <= rc_mean+rc_sd*3) %>%
  subset(cd_mean-cd_sd*3 <= Change | Change <= cd_mean+cd_sd*3) %>%  subset(Rate_Change < 1) #we have a few outliers that need to go

std_corr <- corr %>% 
  mutate(
    Rate_Change = (Rate_Change - rc_mean)/rc_sd
  ) %>% 
  subset(Rate_Change <= 1) #we have a few outliers that need to go
```

First, lets check to see if our Rate of Change is relatively normal.

```{r}
shapiro.test(std_corr$Rate_Change)
```

This tells us that our p value is 0.1314 > 0.05

This is great news! It means our data is normal, and this means that we can use our Rate of Deaths as a predictor for our model!

```{r}
hchart(density(std_corr$Rate_Change), type = "area", color = "red", name = "Rate of Deaths") %>%
  hc_add_theme(hc_theme_flat()) %>% 
  hc_title(text = "Distribion of the Rate of Change, per Day",
           align = "left") %>% 
  hc_subtitle(text = "For Italy",
              align = "left") %>% 
  hc_yAxis(labels = list(format = "{value}")) %>% 
  hc_xAxis(labels = list(format = "{value}"),
           title = list(text = "Rate of Change"))%>% 
  hc_legend(align = "left") %>% 
  hc_exporting(enabled = TRUE,
               filename = "it-dist-roc")
```


```{r}
corr %>% 
  cor() %>% #get correlation
  round(3) %>% #round
  hchart() %>% #graph
  hc_add_theme(hc_theme_flat()) %>%
  hc_title(text = "Pearsons r matchup",
           align = "left") %>% 
  hc_subtitle(text = "For Italys' Deceased Cases",
              align = "left") %>% 
   hc_xAxis(categories = list("Cumulative Deaths", "Cases per Day", "Rate of Change")) %>% 
  hc_yAxis(categories = list("Cumulative Deaths", "Cases per Day", "Rate of Change"))%>% 
   hc_legend(align = "left") %>% 
  hc_plotOptions(
           series = list(
             boderWidth = 0,
             dataLabels = list(enabled = TRUE)))
```

## Finding the significance of Italys' Rate of Deceased Cases

As expected there is a negative correlation between the Rate of Change and Total cases, aswell as a negative correlation between our Rate of Change and the cases per day.

This makes sense as the amount of cases increase, our rate should start having less variations. This is also great news, as it means our rate is trending downwards, ultimately suggesting that the rate of Deaths per day is slowing down.

```{r}
corr %>% 
  cor() %>% #get correlation
  '^'(2) %>% #square numbers
  round(3) %>% #round
  hchart() %>% #graph
  hc_add_theme(hc_theme_flat()) %>%
  hc_title(text = "Pearsons r squared matchup",
           align = "left") %>% 
  hc_subtitle(text = "For Italys' Deceased Cases",
              align = "left") %>% 
   hc_xAxis(categories = list("Cumulative Deaths", "Cases per Day", "Rate of Change")) %>% 
  hc_yAxis(categories = list("Cumulative Deaths", "Cases per Day", "Rate of Change"))%>% 
   hc_legend(align = "left") %>% 
  hc_plotOptions(
           series = list(
             boderWidth = 0,
             dataLabels = list(enabled = TRUE)))
```

The r squared value can tell us much more, for example, we know that 88.7% of our Cases per day can be explained by our Total cases! This also tells us that 29.4% of our Cumulative cases can be explained by the variations in the Rate of Change.

Let's check if these values are statistically significant, to do that we need the below formula to get our test statistic.

${ts} = \frac{r*\sqrt[2]{n-2}}{\sqrt[2]{1-r^2}}$

```{r}
df = nrow(corr)-2 #our degree of freedom
cv = qt(.975, df) #our test statistic
r <- corr %>% #correlating our data for r values
  cor()

call_ts <- function(r, df){#function for getting the test statistic
    ts= abs((r*(df)^.5)/(1-(r)^2)^.5) #formula
    return (ts)
  }

#changing our matrix to be the test statistics
ts <- call_ts(r, df)
ts
```

These are our test statistics for each r value, now we need to use the below formula to check if the r value is statistically significant.

${-ts} > r > ts$

Here is a matrix of our r values.
```{r}
r
```

This tells us that our all our correlations are statistically significant! Which means that we can use all of our factors as a predictor of the other.

I will be using the correlation between Italys' Deaths rate of change to predict our Deaths per day values, as this is a statistically significant correlation, and the math lines up.

# Building a model of Italys' Deaths per day

## Facts before the build

There are two things I want to point out about Covid-19:

* We know the median incubation period is 5 days.
    + This means that there is most likely a 5 day lag in our confirmed cases, as 50% of infected individuals will not experience any symptoms before the incubation period.

* We know the average days from illness onset to death is 18 days.
    + This can help us estimate the amount of infections 23 days prior.
    
Using these two facts, we can estimate the average time from point of infection to death is 23 days (5 incubation days + 18 days till death). This means that if someone dies today from Covid-19 we can estimate that they got infected 23 days prior.
    
sources: 

https://www.uptodate.com/contents/coronavirus-disease-2019-covid-19?source=history_widget

https://www.thelancet.com/journals/lancet/article/PIIS0140-6736(20)30566-3/fulltext

I want to first build a model of Italys' predicted Deaths per day, this can further help us find the actual number of confirmed cases!

## Building the predicted Deaths per day

There are a few things I want to note:

* The reported Deaths are likely to be the most accurate.
    + This is due to the fact that there are likely much more confirmed cases of Covid-19 than what is reported.
        - Covid-19 is known to be transmittable by people without showing symptoms.
        - Not everyone will be tested.

* Using the Deaths rate of change, we can estimate the future Deaths to be reported.
    
So lets get started!

### The math behind the model

$ {Deaths} =  {Infected}*{MortalityRate} $

This is our formula to find the number of Deaths from any given population of infected individuals. We are focusing on the Deaths per day, as I want a per day model.

This means we need to take the derivative of our formula, with respect to time. This leads into a two options:

* The Mortality Rate is a constant value for the population.

* The mortality Rate is a value that also changes with time.

$ D = Deaths, I = Infected, R = MortalityRate $

If we take the derivative with Mortality Rate as a variable we get the following: 

* $ \frac{dD}{dt} = \frac{dI}{dt}*\frac{dD}{dI} + \frac{dR}{dt}*\frac{dD}{dR} $

* $ \frac{dD}{dt} = \frac{dI}{dt}*R + \frac{dR}{dt}*I $

In plain terms, the change in Deaths is equal to the change in infections, time the Mortality Rate, plus, the change in Mortality Rate, times the infections.

There is one major problem with this, we cannot make an accurate estimate on the Mortality Rate, which means we also cannot make an accurate estimate on the change in Mortality Rate. So, while this would be the better option, I do not believe it is feasable with the data we have now, as we cannot get an accurate Mortality Rate.


However, taking the derivative with Mortality Rate as a constant gives us the following:

* $ \frac{dD}{dt} = \frac{dI}{dt}*R $

which also tells us..

* $ \frac{dI}{dt} = \frac{\frac{dD}{dt}}{R}$

In plain terms, we get that the change in Deaths is equal to the change in the infections, times the Mortality Rate. We also know that the change in infections is equal to the change in Deaths, divided by the Mortality Rate.

This means that with a constant Mortality Rate, the change in Deaths will also be the same as the change in Infections! As the rate is just scaling the numbers. This tells us we can make predictions on the change in Infections using the change in Deaths, scaling with the Mortality Rate!


Using this information, I will build my model with Mortality Rate as a constant.

## The math behind predictions

To start, there are a few things to note about how I built this algorithm:

* Only the bottom quarter of the data is being assessed for its changes in rates.
    + This is so that we can get an accurate start to our model, we also want to keep the range of possible change in rates lower, as to follow the trend of the predicted line.

* Once we predict a future rate, we throw away the oldest rate and re-model our predictions!
    + This is to make sure that our model changes in accordance with our predictions, otherwise we would start to see a more linear aspect to our predictions.
    
* I have split this algorithm into multiple functions to stop at certain points, in order to explain whats going on.

Lets dive in by taking a look at how our rates of change work!

# Prediction Analysis and building

To start, we know how much our Deaths are changing per day, we can formulate what percentage this change is from our cumulative Deaths. To do this, we need the following formula:

$ ROC = \frac{Deaths - Deaths_1}{Deaths_1} $

In plain terms, this formula takes the change per day of our deaths, and divides that by our previous days cumulative Deaths! Making the deaths per day into a percentage of our cumulative deaths!

```{r}
split_to_country <- function(data, country){
  #take data and split by country
  #first function for model
  country_data <- data %>% 
    subset(Country == country) %>% #getting italy
    convert() %>% #function converts to wide format
    subset(select = c(Country, Date, Deaths, Confirmed)) %>% 
    mutate( #adding columns for per day change, and rate per day
    Deaths_Per_Day =  Deaths - lag(Deaths, k=1),
    Deaths_Rate_Change =  (Deaths - lag(Deaths, k=1))/lag(Deaths, k=1),
    Mortality_Rate = Deaths/Confirmed
      )

  #cleaning data for further analysis
  country_data <- country_data %>% 
    subset(select = c(Date, Deaths, Deaths_Per_Day, Deaths_Rate_Change)) %>% 
    subset(!is.na(Deaths_Per_Day)) %>% 
    mutate(
      Deaths_PD = Deaths_Per_Day,
      Deaths_RC = Deaths_Rate_Change
    ) %>% 
    subset(select = c(Date, Deaths, Deaths_PD, Deaths_RC))
  return (country_data)
}

italy <- raw %>% 
  split_to_country("Italy")
#showing tail values
tail(italy,5)
```

Now that this step is complete, we can calculate the change in our death rate of change. Essentially looking at how much our rates are fluctiating over time. We can do this simply by taking our first deaths rate of change and subtracting the second days rate of change from that. This will mean if the rate goes up, the change will go up as well!

```{r}
get_dr_c <- function(data){
  #Calulating the change in our rates of change
  data <- data %>% 
    mutate(
      D_RC_C = Deaths_RC - lag(Deaths_RC,k=1)
    )
  return (data)
}

italy <- italy %>% 
  get_dr_c()

tail(italy,5)
```

Great, here are Italys' cumulative Deaths, Deaths per day, Deaths rate of change, and the change in the rate of change. We will use all this information to work backwards at the end, to fill in the predictions.

```{r}
##save og data!
og <- italy

split_for_graph <- function(data, split){
  data <- data %>% 
    subset(!is.na(D_RC_C))
  
  #taking the bottom 8 samples
  data <- data[ceiling(nrow(data)-(split-1)) : nrow(data),]
  
  mu = data %>% 
    subset(select = Deaths_PD) %>% 
    as.matrix() %>% 
    mean()
  
  sd = data %>% 
    subset(select = Deaths_PD) %>% 
    as.matrix() %>% 
    sd()
  
  #getting rid of outliers in the deaths per day
  data <- data %>% 
    subset(mu-sd*3 < Deaths_PD & Deaths_PD < mu+sd*3)
  
  mu <- data %>% 
    subset(select = D_RC_C) %>% 
    as.matrix() %>% 
    mean()
  
  sd <- data %>% 
    subset(select = D_RC_C) %>% 
    as.matrix() %>% 
    sd()
  
  #getting rid of outliers in the change of the rate of change in deaths
  data <- data %>% 
    subset(mu-sd*3 < D_RC_C & D_RC_C < mu+sd*3)
  
  return (data)
}

italy <- italy %>% 
  split_for_graph(8)
```

```{r}
hchart(density(italy$D_RC_C), type = "area", color = "red", name = "Rate of Deaths") %>%
  hc_add_theme(hc_theme_flat()) %>% 
  hc_title(text = "Distribion of the Change in Rate of Change",
           align = "left") %>% 
  hc_subtitle(text = "For Italy",
              align = "left") %>% 
  hc_yAxis(labels = list(format = "{value}")) %>% 
  hc_xAxis(labels = list(format = "{value}"),
           title = list(text = "Change in Rate of Change of Deaths"))%>% 
  hc_legend(align = "left")
```

This is the distribution of the rate of change, we want to take a look at this to make sure it is relatively normal, otherwise there will be a different method needed to make predictions from.

```{r}
shapiro.test(italy$D_RC_C)
```

Exactly what we wanted to see, our p value is > 0.05, meaning our distribution is normal enough to find the probabilities!

## Building the predictions

Now that we have the changes per day, we can build the prediction model. I will break this down into steps:

* Get the current mean and standard deviation of the change in rate

* use rnorm to generate a random sample
  + add up every sample and divide by the number of samples, to get the mean of your change.
    - adding more samples will bring your changes closer to their means, while having fewer samples will keep a bigger variance in our random change.
    
* add this new sample to the bottom of the data pool, take off the top sample to the data pool
  + think of this as a revolving door, the sampling will change with line. This will linearize our function of change, however when we calculate backwards we are effectively taking the integral of it, twice, which gives us our curve!
  
*  Once we have all our predictions we can math backwards!

* Calculate the missing rate of changes, based off the value of your change in rate and previous rate!

* Calculate the per death amound by taking the previous per death time your new rate of change
  + after this, since the rate 'should' trend downwards, the algorithm will end up with negative per day results. This is to be expected, however we cannot lose infected individuals so we need to fix this.
    - we fix this by multiplying by -1!


* Calculate the total deaths by taking the previous deaths total and adding the new per day
  + when those negative numbers go through the algorithm, it will subtract from our total deaths! To reverse this, we add two times our old per day amount, assuming we have already multiplied by -1.
  
* Thats it!

```{r}
### functions used inside function below
get_rc <- function(death_rc_n1, change){
  #rc = lag death_rc + change
  rc=death_rc_n1+change
  return(rc)
}
  
get_pd <- function(deaths_n1, deaths_rc){
  #lag death*roc = pd
    pd = (deaths_rc*deaths_n1)
  
  return(ceiling(pd))
}
  
get_death <- function(lag_death = lag_death, dpd){
  #lag death + death per day = next cumulative death
  death = lag_death+dpd
  return(ceiling(death))
}

get_random <- function(n,mu, sd){
  rand =0
  for (i in 1:n){
    i = i*11 #this is done to get vast variances in our seeds
    set.seed(i)
  rand <- rand + rnorm(1, mu, sd)
  }
  rand <- rand/n
  return(rand)
}

### function used for prediction model
prediction_model <- function(data, TRIALS, og_d, days, r_seed, country){
  #set.seed(r_seed)
  
  mu <- data %>% #grabbing first mean
    subset(select = D_RC_C) %>% 
    as.matrix() %>% 
    mean()
  
  sd <- data %>% #grabbing firs standard deviation
    subset(select = D_RC_C) %>% 
    as.matrix() %>% 
    sd()
    
  pred <- get_random(TRIALS,mu,sd) #getting a random prediction
  
  temp <- data
  
  
  for (i in 1:days){ #loop for the days we want
    curr_d = max(temp[temp$D_RC_C != 0,"Date"])
    
    temp <- temp %>% #adding our prediction, taking off the top value
      bind_rows(data.frame(Date = curr_d+1, Deaths = 0, Deaths_PD = 0, Deaths_RC = 0, D_RC_C = pred[1])) %>% 
      slice(-1)
    
    data <- temp %>% #adding our prediction to the overall data
      bind_rows(data.frame(Date = curr_d+1, Deaths = 0, Deaths_PD = 0, Deaths_RC = 0, D_RC_C = pred[1])) %>% 
      slice(1) %>% 
      bind_rows(data)
  
    mu <- data %>% #grabbing the new mean
    subset(select = D_RC_C) %>% 
    as.matrix() %>% 
    mean()
  
    sd <- data %>% #grabbing the new standard deviation
    subset(select = D_RC_C) %>% 
    as.matrix() %>% 
    sd()
  
    pred <- get_random(TRIALS,mu,sd) #grabbing the new prediction!
  } #repeat
  
  data <- data %>% #combining our data back to our real data
    slice(-1) %>% 
    bind_rows(og_d) %>% 
    arrange(Date)
  
  data <- data[!duplicated(data$Date), ] #ended up with duplicates, lets get rid of those
     
  #taking the last row where our deaths aren't 0
  temp <- data %>% 
    subset(Deaths != 0) %>% 
    slice(n())
   
  # adding that row to our data
  temp <- data %>% 
    subset(Deaths == 0) %>% 
    bind_rows(temp) %>% 
    arrange(Date)
  
  
  #Here is where I get our values based on our predictions!
  for (i in 2:nrow(temp)){
     #getting roc
      temp[i,4] <- get_rc(temp[i-1,4], temp[i,5])
      
      #getting deaths per day
      temp[i,3] <- get_pd(temp[i-1,2], temp[i,4])
      
      #getting cumulative deaths
      temp[i,2] <- get_death(temp[i-1,2], temp[i,3])
  }
  
  
  #Here is where we need to fix our data, we ended up getting negative deaths per day after a certain time, and this started making the cumulative deaths decrease. This is intended, as we need these deaths per day values, but we need to swap it back to positive!
  
  #Another thing to note, is I changed the cumulative deaths to match our decreasing deaths per day, essentially this fixes our model to reflect the real world, as people cannot become undead!
  
  for (i in 2:nrow(temp)){
    
    if (temp[i,3] < 0){
        temp[i,3] <- temp[i,3]*-1
        temp[i,2] <- temp[i-1,2] + (2*temp[i,3]) #adjust from previous calculations using negative numbers
    }
    else{
      temp[i,2] <- temp[i-1,2] + temp[i,3] #recalculate, this is incase it bounces beteween negative and positive
    }
  }

 temp <- temp %>% 
    mutate(
      Country = country
    )
  
  return (temp)
}

italy <- italy %>% 
  prediction_model(TRIALS = 1000, og_d = og, days = 100, r_seed = 23, country = "Italy")

og <- og %>% 
  mutate(
    Country = "Italy"
  )
```

## Taking a look at our predicted Deaths

```{r}
pred_italy <- italy %>% 
  subset(Deaths_PD != 0) %>% 
  slice(-n()) %>% 
  arrange(Date) %>%
  slice(-1) %>% 
  bind_rows(og) %>% 
  arrange(Date) %>% 
  subset(select = c(Country, Date, Deaths, Deaths_PD, Deaths_RC, D_RC_C))

pred_italy %>% 
  hchart(type = "line", hcaes(x=Date, y=Deaths), color = "red", name = "Total Deaths") %>% 
  hc_add_theme(hc_theme_flat()) %>% 
  hc_title(text = "Italys' projected Deaths",
           align = "left") %>% 
  hc_subtitle(text = "Using my prediction model",
              align = "left") %>% 
  hc_yAxis(labels = list(format = "{value}"), title = list(text = "Cumulative Number of Deaths")) %>% 
  hc_xAxis(title = list(text = "Date"),
           plotBands = list(
             list(
               label = list(text = "This is the Predicted Data"),
               color = "lightblue",
               from = datetime_to_timestamp(as.Date('2020-03-24')),
               to = datetime_to_timestamp(as.Date('2020-06-02'))
             )))%>% 
  hc_legend(align = "left")
```

```{r}
rm(list=setdiff(ls(), list("pred_italy", "raw")))
```